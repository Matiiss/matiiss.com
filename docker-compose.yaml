name: matiiss-com

networks:
  backend:

volumes:
  nginx_cache:
  tls:
  acme.sh:

services:
  reverse-proxy:
    build:
      context: ./reverse_proxy
      dockerfile: Dockerfile
    networks:
      - backend
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - nginx_cache:/var/cache/nginx
      - tls:/etc/nginx/ssl
    labels:
      - sh.acme.autoload.domain=matiiss.com
  backend:
    depends_on:
      - acme.sh
    build:
      context: ./backend
      dockerfile: Dockerfile
    networks:
      - backend
    ports:
      - "8000:8000"
  acme.sh:
    image: neilpang/acme.sh
    container_name: acme.sh
    entrypoint: |-
      /bin/sh -c '
      /entry.sh daemon;
      /entry.sh --register-account -m matiiss@matiiss.com;
      /entry.sh --issue --ecc --dns dns_dgon -d matiiss.com -d www.matiiss.com -d blog.matiiss.com -d www.blog.matiiss.com;
      /entry.sh --deploy --ecc -d matiiss.com -d *.matiiss.com --deploy-hook docker;
      '
    volumes:
      - acme.sh:/acme.sh
      - /var/run/docker.sock:/var/run/docker.sock
    env_file: .env-acme-sh
    environment:
      - DO_API_KEY=${DIGITALOCEAN_API_KEY}
